## Цель
- Добавить вкладку `Translations`, которая позволяет вручную заводить прогнозы для перевода, запускать автоматический пайплайн перевода (prepare → primary → revision) и просматривать готовый результат.
- Обеспечить отправку уведомления в Slack после успешного завершения перевода с фиксацией затраченного времени.
- Сохранить структуру и принципы, использованные на вкладке новостей (`News`), но упростить пользовательский поток и минимизировать количество промежуточных состояний.

## Область работ
- Новый маршрут `/translations` со списком записей из `translations.inbox`.
- Новый маршрут `/translations/:id` с карточкой конкретного перевода.
- Добавление модалки создания записи с действиями "Добавить" и "Добавить и сразу перевести".
- Добавление API-слоя для работы с эндпойнтами `autonews_api/v1/translations/*` и Slack-эндпойнтом.
- Отсутствие переключения окружений: используется общее значение `VITE_NEWS_API_BASE` (переименовывать не требуется, но в коде лучше ввести отдельный alias для переводов).
- Публикации (`translations.publications`) на первом этапе не выводим. Фильтры по языкам/статусам не добавляем.

## Источники данных и эндпойнты
- Документация и тестирование REST-эндпойнтов доступны в Swagger по адресу `http://46.101.120.80:8027/` (раздел `autonews_docs`). Там же можно выполнить запросы в режиме Try It Out.
- Информацию о структуре таблиц и примеры данных (например, `translations.inbox`) можно получить через сервис БД, например `http://46.101.120.80:8024/betshot_db_api/v1/{table}/info`.
- `GET /autonews_api/v1/translations/inbox` — список записей. Поддерживает `page`, `page_size`, `sort_by`, `sort_order`. Ответ аналогичен news: `records`, `total_count`, `total_pages`, `page` и т. д.
- `GET /autonews_api/v1/translations/inbox/{id}` — одна запись.
- `POST /autonews_api/v1/translations/inbox` — создание записи. Из Swagger: обязательные поля `headline_raw`, `body_raw`. Необязательные/опциональные: `source_language`, `target_language`, `notes`.
- `PATCH /autonews_api/v1/translations/inbox/{id}/status` — обновление статуса записи. Доступный словарь (по данным БД): `new`, `processed`, `ready_to_publish`, `failed`, `rejected`. Реализовать как конфиг с graceful fallback (если приходит неизвестный статус — отображать raw строку).
- `POST /autonews_api/v1/translations/prepare` — подготовка текста для перевода. Тело запроса: `{ "inbox_id": number, "gpt_prompt_id": 1 }`. Сохраняет структурированный текст в `inbox.body_prepared`.
- `POST /autonews_api/v1/translations/primary` — генерация основного перевода. Тело запроса: `{ "inbox_id": number, "gpt_prompt_id": 2 }`. Записывает черновой перевод в `inbox.payload_json`.
- `POST /autonews_api/v1/translations/revision` — ревизия перевода. Используется дважды: с `gpt_prompt_id: 3` (корректировка терминологии) и `gpt_prompt_id: 4` (британская спортивная лексика). Каждый вызов обновляет `inbox.payload_json`.
- `POST /autonews_api/v1/slack_reports` — отправка сообщения в канал Slack. Тело: `{ "channel_id": "C08QWES1YBG", "text": "..." }`. Возвращает `id` записи.

> **Примечание:** фронтенд должен работать с реальными контрактами из Swagger. Если структура запросов отличается от предположений, обновить код, но интерфейс остаётся прежним.

## UI: маршрут `/translations`

### Размещение
- Добавить пункт `Translations` в основной навигации (рядом с `News`), открывающий компонент `TranslationsPage`.

### Структура страницы
1. Заголовок и краткое описание.
2. Блок действий: кнопка `Добавить прогноз` (откроет модалку).
3. Таблица с записями.
4. Пагинация (переиспользовать `Pagination` из news, если возможно, либо вынести общую реализацию).

### Таблица
Минимальный набор колонок (упорядочить по убыванию `id`):
- `ID`.
- `Название/описание` — показывать `headline_raw`, если оно заполнено; иначе брать первую строку `body_raw` (до ~80 символов) или выводить «(без названия)».
- `Статус` (с цветной меткой).
- `Создана` (`created_at` → формат `dd.MM.yyyy HH:mm`).
- `Создал` (`created_by`, fallback «—»).
- `Время обновления` (`updated_at` → тот же формат).
- `Действия` (кнопки).

Состояние статусов:
- `new` → «Новый», серый бейдж.
- `processed` → «В работе», жёлтый бейдж.
- `ready_to_publish` → «Готово», зелёный бейдж.
- `failed` → «Ошибка», красный бейдж.
- `rejected` → «Отклонён», тёмно-красный/серый бейдж.
- Неизвестные статусы — выводить текст как есть + серый бейдж.

### Кнопки действий в строке
- `Перевести` — доступна, если `status` не `processed`. При нажатии запускает пайплайн (см. ниже).
- `Смотреть перевод` — активна, если `payload_json` не `null`. Ведёт на `/translations/{id}` (открывается в новой вкладке/внутренняя навигация через `react-router`).
- На уровне MVP не добавляем кнопок «Удалить», «Редактировать» и т. п.

### Состояния загрузки
- Пока идёт загрузка списка — показываем `Loader` (как на News).
- Ошибка загрузки — красный алерт с текстом.

## Модалка «Добавить прогноз для перевода»

### Поля формы
- `Headline` — обязательное поле (input).
- `Source language` — выпадающий список / input (опционально). По умолчанию подставлять `world`; при необходимости пользователь может выбрать другое значение.
- `Target language` — input (опционально).
- `Текст для перевода` (`body_raw`) — многострочный textarea, обязательное поле.
- Дополнительные поля из Swagger (`notes` и т. п.) — по необходимости (можно скрыть за collapsible).

### Кнопки
- `Отмена` — закрывает модалку без действий.
- `Добавить` — вызывает `POST /translations/inbox`, закрывает модалку, показывает уведомление, обновляет список (перейти на первую страницу).
- `Добавить и сразу перевести` — тот же `POST`, но после успешного создания автоматически запускает пайплайн перевода для созданной записи.

### Валидация
- Минимально: не позволяем отправить пустой `body_raw`. Остальное валидирует backend.
- При ошибке отображаем сообщение под формой.

## Пайплайн «Перевести»

### Последовательность шагов
1. Зафиксировать `startTime = Date.now()`.
2. Обновить статус записи на `processed` через `PATCH /translations/inbox/{id}/status` (payload `{ "status": "processed" }`).
3. Вызвать `POST /translations/prepare` с телом `{ "inbox_id": id, "gpt_prompt_id": 1 }`.
4. Вызвать `POST /translations/primary` с телом `{ "inbox_id": id, "gpt_prompt_id": 2 }`.
5. Последовательно вызвать `POST /translations/revision` дважды:
   - `{ "inbox_id": id, "gpt_prompt_id": 3 }` — правка беттинг-терминологии.
   - `{ "inbox_id": id, "gpt_prompt_id": 4 }` — адаптация под британскую спортивную лексику.
6. После второго вызова выполнить `GET /translations/inbox/{id}` для получения финального `payload_json`.
7. Обновить статус на `ready_to_publish` (если бэкенд не сделал это автоматически) через `PATCH` с `{ "status": "ready_to_publish" }`.
8. Рассчитать длительность: `durationSec = Math.round((Date.now() - startTime) / 1000)`.
9. Сформировать и отправить Slack-отчёт.
10. Отобразить уведомление об успехе и обновить таблицу.

### Обработка ошибок
- Если любой из шагов 3–5 (или ревизий) возвращает ошибку/timeout:
  - Показываем уведомление с текстом.
  - При необходимости обновляем статус `failed`.
  - Разрешаем повторный запуск кнопкой `Перевести`.
- Если `GET /inbox/{id}` не вернул `payload_json`, но шаги прошли успешно — показываем предупреждение, что результат ещё не готов; разрешаем повторный опрос.
- При отмене/закрытии страницы во время выполнения — отображаем loader на кнопке и отключаем повторные клики. AbortController можно опустить (пайплайн короткий), но предусмотреть флаг `isProcessing` на уровне строки.

### Slack-отчёт
- Канал: `C08QWES1YBG`.
- Формат сообщения (пример):
  ```
  Перевод #{{id}} готов.
  Описание: {{titleOrSnippet}}
  Длительность: {{minutes}} мин {{seconds}} с.
  Ссылка: {{host}}/translations/{{id}}
  ```
- `host` — текущее значение `window.location.origin`.
- `titleOrSnippet` — то же значение, что показываем в колонке «Название/описание» (заголовок или усечённый `body_raw`).
- Отправлять сразу после того, как `payload_json` подтверждён.
- При ошибке отправки Slack — логировать в консоль и показывать тост, но процесс перевода считать успешным.

### Локальные индикаторы
- В строке таблицы во время выполнения отображать спиннер и текст «Переводим…».
- Одновременно показывать секундомер (формат `мм:сс`) и тонкий прогресс-бар: 0–5 минут соответствуют 0–100%. После 5 минут шкала остаётся заполненной, перекрашивается в красный, секундомер тоже становится красным и отображает подсказку «долго».
- После завершения можно кратко подсветить строку (опционально).

## Страница `/translations/:id`

### Поведение
- При открытии делать `GET /translations/inbox/{id}`.
- Если запись не найдена — показать «404 / Запись не найдена» и ссылку вернуться к списку.

### Содержимое
- Заголовок с `headline_raw` и статусом.
- Метаданные: ID, создана/обновлена, автор.
- Блок «Исходный текст» (`body_raw` с `white-space: pre-wrap`).
- Блок «Подготовленный текст» (`body_prepared`), если есть (raw JSON отображать в `<pre>` с подсветкой, предусмотреть кнопку «Скопировать»).
- Блок «Итоговый перевод» (`payload_json`) — отображать JSON с форматированием, кнопка «Скопировать». Промежуточные состояния отдельно не сохраняем и не показываем.
- Блок «Справочные данные» (например, `terms_and_names_web_translation`, `vague_terms_notions`) — разворачивающийся `<details>`.
- Линк «Вернуться к списку».

## Архитектура и кодовая база
- Создать каталог `src/translations/` с подпапками `api`, `components`, возможно `hooks`.
- `translationsService.js` (аналог `newsService.js`): функции для всех эндпойнтов.
- `TranslationsPage.jsx` — страница со списком.
- `components/TranslationsTable.jsx`, `components/TranslationCreateModal.jsx`, `components/StatusBadge.jsx` и т. п.
- `TranslationDetailsPage.jsx` — страница карточки.
- Роутинг: обновить `App.jsx`/`main.jsx`, добавить новый маршрут и ссылку в навигации.
- Состояния/хранилище: достаточно `useState`/`useEffect`; интеграция с `store/auth-store.js` не требуется.
- Форматирование дат — использовать `new Date(val).toLocaleString("ru-RU", ...)` (как в News).

## UX-детали
- После успешного создания записи показывать тост «Запись добавлена».
- После запуска перевода — «Перевод запущен»; по завершении — «Перевод готов». Ошибки — красный тост.
- При повторной генерации (если потребуется) предупреждать, что результат перезапишет существующий перевод.

## Тайминг перевода
- Время измеряет фронтенд. Если во время пайплайна страница перезагружается, время собьётся — это допустимо на MVP.
- Значение отправляем в Slack как целые секунды; в UI можно показывать `~1 мин 25 с` (опционально).

## Нефункциональные требования
- Соблюдать текущие ESLint/Prettier правила.
- Не модифицировать существующую логику News.
- Все тексты/лейблы — на русском.
- Не добавлять сторонние зависимости без согласования.

## Тестирование (ручное, проводит человек)
1. Открыть `/translations`, убедиться что список загружается.
2. Создать новую запись через модалку, проверить, что она появляется в таблице.
3. Создать запись кнопкой «Добавить и сразу перевести», убедиться, что пайплайн стартовал и завершился, статус обновился, пришёл Slack-репорт.
4. Запустить перевод для существующей записи через таблицу, проверить, что кнопка блокируется, статус обновляется, по завершении появляется кнопка «Смотреть перевод».
5. Открыть `/translations/{id}`, проверить отображение всех блоков, ссылки работают.
6. Во время активного перевода наблюдать за секундомером и прогресс-баром: убеждаемся, что до 5 минут идёт плавное заполнение, после 5 минут элементы становятся красными.
7. Проверить ошибки: заведомо неверный `inbox_id` → убедиться, что UI показывает ошибку и даёт повторить.
8. Проверить работу пагинации.

## Открытые вопросы
- Уточнить формат тел для prepare/primary/revision в Swagger (добавлены `gpt_prompt_id`: 1, 2, 3, 4).
- Дополнительные вопросы отсутствуют — промежуточные результаты фронт не хранит, фильтры по языку/статусу не требуются.

## Риски
- API может работать асинхронно; если `prepare/primary/revision` возвращают только `task_id`, придётся добавить поллинг. Следить за Swagger и адаптировать реализацию.
- Объём `payload_json` большой (до десятков кБ). При отображении на странице предусмотреть `overflow: auto`.
- Slack-эндпойнт может не отвечать: показываем предупреждение, но не прерываем UX.

