Техническое задание для Codex-агента
=================================

## Цель
- Перестроить пользовательский поток в `NewsWriterModal`, чтобы после генерации бэкграунда редактор сначала работал с вкладкой заголовков, а затем переходил к написанию текста.
- Использовать эндпойнт `/autonews_api/v1/generate_headlines`, который сохраняет варианты заголовков в `inbox.headlines`, без изменений на backend.

## Источники и проверки
- Документация и Swagger-доступ: `http://46.101.120.80:8027/autonews_docs#/`.
- Все API можно вызывать напрямую по `http://46.101.120.80:8027/autonews_api/v1/` (без авторизации). Тестовый `inbox_id` — `212`.
- Для всех openai-эндпойнтов сохранить текущие значения `gpt_prompt_id` (фон, заголовки, article payload), чтобы не менять формат взаимодействия с LLM.

## Ключевые изменения

### Структура шагов UX
- Добавить шаг `headlines` между существующими `background` и `draft`.
- Обновить константы, подписи шагов, визуальное представление и плейсхолдеры.
- Пока заголовок не выбран, пользователь остаётся на вкладке «Предлагаю заголовки». После выбора автоматически переходит на «Пишем текст».

### Работа с API (`src/news/api/newsService.js`)
- Оставить вызов `generateArticleHeaders` (POST `/generate_headlines`) с сохранением текущих `gpt_prompt_id`. Обрабатывать ошибки/таймауты, не затирать `headlines` при ошибках.
- После генерации заголовков подтягивать свежий `inbox` через `fetchInboxRecord`, чтобы получить записанные `headlines` (без ручного парсинга).
- Убедиться, что `updateInboxArticlePayload` и `updateInboxBackground` не удаляют поле `headlines`.

### Поведение `NewsWriterModal.jsx`
- При инициализации: если бэкграунд уже есть — показывать его; иначе сгенерировать и сохранить, как в текущей реализации. После этого запускать генерацию заголовков. При открытии модалки подхватывать существующие `headlines`, если они есть.
- Вкладка «Предлагаю заголовки»: отображать варианты `header_2`, `header_3`, `header_4`, позволять их редактировать/выбирать. Сохранять выбранный заголовок и `selected_header_number` через существующие хелперы (`updateArticlePayloadWithHeaders`, `persistArticlePayload`).
- Игнорировать `header_1`: финальный выбор всегда основан на `header_2…4` или их правках. При переходе на «Пишем текст» подставлять выбранный заголовок в поле `header` и правильно выставлять `selected_header_number`.
- Генерация текста стартует параллельно чтению/редактированию заголовков. Лоадер выводится на шаге «Пишем текст», пока пользователь остаётся на вкладке «Предлагаю заголовки».
- На вкладке текста: если payload ещё не готов — показывать текущий лоадер «Гэндальф»; после готовности — отрисовать редактор с выбранным заголовком и структурой текста, как сейчас.
- Кнопки публикации должны сохранять актуальный payload и работать с имеющимся триггером `news.build_publication_payload` без бэкенд-изменений.

### Состояния и сохранение
- Развести состояния генерации заголовков и текста, чтобы выбор заголовка не блокировался ожиданием payload.
- При повторной генерации заголовков/текста аккуратно сбрасывать соответствующие части состояния, предупреждая о потенциальной потере несохранённых правок.
- Не допускать регрессий: ручное сохранение бэкграунда, повторная генерация, отмена публикации и прочие сценарии должны остаться рабочими.

### Минимизация переписывания
- Переиспользовать существующие утилиты и helper-функции, если они не мешают новой логике.
- Не переписывать хуки и AbortController без необходимости; допускается точечная реорганизация для читаемости.
- Если определённые блоки проще реализовать заново ради поддержки — допускается, при сохранении архитектурных принципов компонента.

## Тестирование (ручное)
- Прогнать полный сценарий: «Бэкграунд → Заголовки → Текст → Публикация».
- Проверить, что заголовки появляются в `inbox.headlines`, payload — в `inbox.article_payload`, публикации — в `publications.article_payload` (наблюдать в БД во время `npm run dev`).
- Проверить повторную генерацию каждого шага и отмену публикации.
- Открыть модалку с уже существующими `headlines/article_payload`, убедиться, что данные подтягиваются и UI ведёт себя корректно.
- Закрыть модалку во время активных процессов и убедиться, что AbortController корректно отменяет запросы, нет ошибок в консоли.

## Нефункциональные требования
- Соблюдать текущие ESLint/Prettier правила и типизацию.
- Не модифицировать SQL-триггер и функцию `news.build_publication_payload`, если это не станет критической необходимостью.
- Компонент остаётся управляемым по состоянию (React-стейт, без глобальных побочных эффектов).
- Допускается реорганизация файла (вынос подсоставляющих, хелперов) ради читаемости.